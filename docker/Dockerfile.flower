FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 复制requirements文件并安装Python依赖
COPY docker/requirements-flower.txt /tmp/requirements-flower.txt
RUN pip install --no-cache-dir -r /tmp/requirements-flower.txt

# 安装CLIP
RUN pip install git+https://github.com/openai/CLIP.git

# 复制整个项目，保持目录结构
COPY . /app/

# 确保docker目录被正确复制
COPY docker/ /app/docker/

# 调试：列出复制的文件
RUN echo "=== Checking copied files ===" && \
    ls -la /app/ && \
    echo "=== Checking docker directory ===" && \
    ls -la /app/docker/ && \
    echo "=== Checking for server_flower.py ===" && \
    ls -la /app/docker/server_flower.py

# 设置环境变量
ENV PYTHONPATH=/app
ENV TF_CPP_MIN_LOG_LEVEL=3
ENV CUDA_VISIBLE_DEVICES=""
ENV FLWR_TELEMETRY_ENABLED=0

# 创建必要的目录
RUN mkdir -p /app/data /app/output /app/logs

# 确保docker目录中的脚本可执行
RUN chmod +x /app/docker/*.py || true

# 暴露端口
EXPOSE 8080

# 默认命令
CMD ["python", "--version"]